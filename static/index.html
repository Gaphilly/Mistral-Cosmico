<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mistral CÃ³smico</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .indicator {
      margin: 10px 0;
    }
    .progress-container {
      width: 100%;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      height: 20px;
      margin-top: 3px;
    }
    .progress-bar {
      height: 100%;
      text-align: right;
      padding-right: 5px;
      color: white;
      font-weight: bold;
      line-height: 20px;
      border-radius: 6px;
    }
    .rain { background: #4da6ff; }
    .snow { background: #3399ff; }
    .heat { background: #ff6666; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <input type="text" id="search-input" placeholder="Buscar una localidad..." />
    <button onclick="searchLocation()">Buscar</button>
    <div id="info">
      ğŸ“ Coordenadas: <span id="coords">None</span> |
      ğŸ  UbicaciÃ³n: <span id="address">None</span>
    </div>
  </header>

  <div id="main">
    <div id="map"></div>

    <div id="sidebar">
      <label><strong>ğŸ“… Selecciona un dÃ­a y mes:</strong></label>
      <div style="display:flex; gap:5px;">
        <input type="number" id="day-input" placeholder="DÃ­a" min="1" max="31" style="width:70px;">
        <input type="number" id="month-input" placeholder="Mes" min="1" max="12" style="width:70px;">
        <input type="number" id="month-input" placeholder="AÃ±o" min="1980" max="3000" style="width:70px;">
      </div>

      <button id="fetch-btn" onclick="fetchWeather()">ğŸ”® Obtener predicciÃ³n</button>

      <hr />

      <div class="indicator">ğŸŒ¡ï¸ Temperatura promedio: <span id="temp">â€“</span> Â°C</div>

      <div class="indicator" id="precip-label">ğŸŒ§ï¸ Frecuencia lluvia: </div>
      <div class="progress-container">
        <div id="precip-bar" class="progress-bar rain" style="width:0%">0%</div>
      </div>

      <div class="indicator">ğŸ”¥ Probabilidad de calor extremo (&gt;35Â°C): </div>
      <div class="progress-container">
        <div id="heat-bar" class="progress-bar heat" style="width:0%">0%</div>
      </div>

      <hr />
      <div id="status" style="font-size:0.9em;color:#888;">Haz clic en el mapa o busca una localidad</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([48.8566, 2.3522], 5); // ParÃ­s
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

let marker = null;
let currentCoords = { lat: 48.8566, lng: 2.3522 };

function updateInfo(lat, lng, address = 'None') {
  document.getElementById('coords').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  document.getElementById('address').textContent = address;
}

function updateMarker(lat, lng) {
  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lng]).addTo(map);
  map.setView([lat, lng], 8);
  reverseGeocode(lat, lng);
  currentCoords = { lat, lng };
}

map.on('click', e => updateMarker(e.latlng.lat, e.latlng.lng));

function searchLocation() {
  const query = document.getElementById('search-input').value;
  if (!query) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        const { lat, lon } = data[0];
        updateMarker(parseFloat(lat), parseFloat(lon));
      } else alert("Localidad no encontrada.");
    });
}

function reverseGeocode(lat, lng) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(res => res.json())
    .then(data => updateInfo(lat, lng, data.display_name || "DirecciÃ³n desconocida"))
    .catch(() => updateInfo(lat, lng, "Error de geocodificaciÃ³n"));
}

function fetchWeather() {
  const day = parseInt(document.getElementById('day-input').value);
  const month = parseInt(document.getElementById('month-input').value);
  if (!day || !month) {
    document.getElementById('status').textContent = "Selecciona un dÃ­a y mes antes de obtener la predicciÃ³n.";
    return;
  }

  const { lat, lng } = currentCoords;
  document.getElementById('status').textContent = "Obteniendo predicciÃ³n...";

  fetch(`/climate_stats?day=${day}&month=${month}&lat=${lat}&lon=${lng}`)
    .then(r => r.json())
    .then(data => {
      // Temperature
      document.getElementById('temp').textContent = data.avg_temp_C?.toFixed(2) ?? "No data";

      // Precipitation
      let precipValue = data.rainfall_gt_2mm_freq_percent ?? data.snow_hail_freq_percent;
      let precipLabel = data.snow_hail_freq_percent !== undefined ? "â„ï¸ Probabilidad nieve/granizo" : "ğŸŒ§ï¸ Frecuencia lluvia (>2mm)";
      document.getElementById('precip-label').textContent = precipLabel;
      let precipBar = document.getElementById('precip-bar');
      precipBar.style.width = precipValue + "%";
      precipBar.textContent = precipValue + "%";
      precipBar.className = "progress-bar " + (data.snow_hail_freq_percent !== undefined ? "snow" : "rain");

      // Heat
      let heatValue = data.high_heat_freq_percent ?? 0;
      let heatBar = document.getElementById('heat-bar');
      heatBar.style.width = heatValue + "%";
      heatBar.textContent = heatValue + "%";

      document.getElementById('status').textContent = "PredicciÃ³n actualizada âœ…";
    })
    .catch(err => {
      console.error(err);
      document.getElementById('status').textContent = "Error al obtener la predicciÃ³n âŒ";
    });
}

// Inicializar con ParÃ­s
updateMarker(48.8566, 2.3522);
</script>
</body>
</html>
