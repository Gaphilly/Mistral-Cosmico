<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte avec Météo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="app">
  <header>
    <input type="text" id="search-input" placeholder="Buscar una localidad..." />
    <button onclick="searchLocation()">Buscar</button>
    <div id="info">
      📍 Coordenadas: <span id="coords">None</span> |
      🏠 Ubicación: <span id="address">None</span>
    </div>
  </header>

  <div id="main">
    <div id="map"></div>

    <div id="sidebar">
      <label><strong>📅 Seleccionar una fecha:</strong></label>
      <input type="date" id="date-input" />

      <button id="fetch-btn" onclick="fetchWeather()">📊 Obtener datos</button>

      <hr />

      <div class="indicator">🌧️ Lluvia promedio: <span id="rain">–</span> mm</div>
      <div class="indicator">🌡️ Temperatura promedio: <span id="temp">–</span> °C</div>

      <hr />
      <div id="status" style="font-size:0.9em;color:#888;">Haz clic en el mapa o busca una localidad</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([48.8566, 2.3522], 5); // Paris por defecto

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
  }).addTo(map);

  let marker = null;
  let currentCoords = { lat: 48.8566, lng: 2.3522 };

  function updateInfo(lat, lng, address = 'None') {
    document.getElementById('coords').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    document.getElementById('address').textContent = address;
  }

  function updateMarker(lat, lng) {
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);
    map.setView([lat, lng], 8);
    reverseGeocode(lat, lng);
    currentCoords = { lat, lng };
  }

  map.on('click', function(e) {
    const { lat, lng } = e.latlng;
    updateMarker(lat, lng);
  });

  function searchLocation() {
    const query = document.getElementById('search-input').value;
    if (!query) return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length > 0) {
          const { lat, lon } = data[0];
          updateMarker(parseFloat(lat), parseFloat(lon));
        } else {
          alert("Localidad no encontrada.");
        }
      });
  }

  function reverseGeocode(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
      .then(res => res.json())
      .then(data => {
        const address = data.display_name || "Dirección desconocida";
        updateInfo(lat, lng, address);
      })
      .catch(() => {
        updateInfo(lat, lng, "Error de geocodificación");
      });
  }

  function fetchWeather() {
    const date = document.getElementById('date-input').value;
    if (!date) {
      document.getElementById('status').textContent = "Selecciona una fecha antes de obtener los datos.";
      return;
    }

    const { lat, lng } = currentCoords;
    document.getElementById('status').textContent = "Consultando datos meteorológicos...";

    Promise.all([
      fetch(`/temp_avg?date=${date}&lat=${lat}&lon=${lng}`).then(r => r.json()),
      fetch(`/precip_avg?date=${date}&lat=${lat}&lon=${lng}`).then(r => r.json())
    ])
    .then(([tempData, precipData]) => {
      const temp = tempData.temp_avg_C ?? "–";
      const rain = precipData.precip_avg_mm ?? "–";
      document.getElementById('temp').textContent = temp === "–" ? "No data" : temp.toFixed(2);
      document.getElementById('rain').textContent = rain === "–" ? "No data" : rain.toFixed(2);
      document.getElementById('status').textContent = "Datos actualizados ✅";
    })
    .catch(err => {
      console.error(err);
      document.getElementById('status').textContent = "Error al consultar los datos ❌";
    });
  }

  // Inicializar con París
  updateMarker(48.8566, 2.3522);
</script>

</body>
</html>
